# מערכת ניהול האימות - תיעוד טכני

## סקירה כללית

מערכת ניהול האימות מטפלת ברענון אוטומטי של טוקנים, מעקב אחר פעילות המשתמש, וניהול תפוגת הסשן.

## רכיבים עיקריים

### 1. PersistLogin.js
**מטרה**: ניהול מצב האימות ורענון אוטומטי של טוקנים

**פונקציונליות עיקרית**:
- מעקב אחר פעילות המשתמש (mouse, keyboard, touch)
- רענון אוטומטי של טוקן 5 דקות לפני תפוגה
- השעיה אחרי שעה של חוסר פעילות
- ניהול טיימרים ואירועים

**טיימרים**:
- `inactivityTimeoutRef`: שעה של חוסר פעילות
- `refreshTimeoutRef`: רענון לפני תפוגת טוקן

### 2. authSlice.js
**מטרה**: ניהול מצב האימות ב-Redux

**מצבים**:
- `token`: טוקן הגישה הנוכחי
- `expirationTime`: זמן תפוגת הטוקן (בשניות)
- `needsReauth`: דגל המצביע על צורך באימות מחדש
- `isInitialized`: האם המערכת אותחלה

### 3. useAuthStatus.js
**מטרה**: Hook לבדיקת מצב האימות

**מחזיר**:
- `token`: הטוקן הנוכחי
- `isExpired`: האם הטוקן פג תוקף
- `timeToExpiry`: זמן עד תפוגה (במילישניות)
- `expirationTime`: זמן תפוגה מוחלט

### 4. authApiSlice.js
**מטרה**: ניהול קריאות API לאימות

**Mutations**:
- `login`: התחברות משתמש
- `refresh`: רענון טוקן
- `logout`: התנתקות

### 5. authConstants.js
**מטרה**: קבועים למערכת האימות

**קבועים עיקריים**:
- `INACTIVITY_TIMEOUT`: 60 דקות (שעה)
- `REFRESH_BEFORE_EXPIRY`: 5 דקות
- `MAX_INACTIVE_TIME_FOR_REFRESH`: 10 דקות

## תהליכים עיקריים

### רענון אוטומטי
1. **מתזמן רענון**: 5 דקות לפני תפוגת הטוקן
2. **בדיקת פעילות**: רק אם המשתמש היה פעיל ב-10 דקות האחרונות
3. **ביצוע רענון**: קריאה ל-API ועדכון הטוקן
4. **טיפול בשגיאות**: logout אוטומטי במקרה של כשל

### מעקב פעילות
1. **אירועי פעילות**: mousemove, keydown, click, scroll, touchstart, focus, blur
2. **עדכון זמן**: כל פעילות מעדכנת את `lastActivityRef`
3. **איפוס טיימר**: כל פעילות מאפסת את טיימר חוסר הפעילות
4. **השעיה**: אחרי שעה ללא פעילות - `setNeedsReauth()`

### ניהול תפוגה
1. **בדיקה רציפה**: useAuthStatus בודק את תוקף הטוקן
2. **UI מותנה**: הצגת SessionExpiredModal כאשר נדרש reauth
3. **ניקוי**: ניקוי טיימרים ומאזינים בעת יציאה

## שגיאות נפוצות וטיפול

### שגיאה: "המסך מופיע אחרי שעה גם עם פעילות"
**סיבה**: טיימר התפוגה לא מתואם עם רענון הטוקן
**פתרון**: רענון 5 דקות לפני תפוגה + בדיקת פעילות

### שגיאה: "רענון לא עובד"
**סיבה**: חוסר credentials או שגיאות API
**פתרון**: credentials: 'include' + טיפול מקיף בשגיאות

### שגיאה: "טיימרים לא מתנקים"
**סיבה**: memory leaks
**פתרון**: useEffect cleanup functions + refs לטיימרים

## בדיקות מומלצות

1. **פעילות רגילה**: וודא שהמשתמש לא מופנה להתחברות בפעילות רגילה
2. **חוסר פעילות**: וודא השעיה אחרי שעה ללא פעילות
3. **רענון**: וודא רענון אוטומטי לפני תפוגה
4. **שגיאות רשת**: וודא טיפול נכון בשגיאות refresh
5. **ניקוי**: וודא שטיימרים מתנקים בעת navigation

## הגדרות נוספות

לשינוי זמני השעיה וטיימרים, ערוך את `authConstants.js`:

```javascript
export const AUTH_TIMEOUTS = {
  INACTIVITY_TIMEOUT: 90 * 60 * 1000, // 90 דקות במקום 60
  REFRESH_BEFORE_EXPIRY: 10 * 60 * 1000, // 10 דקות במקום 5
  // ...
};
```
